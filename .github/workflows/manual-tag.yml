name: Manual Release Trigger

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  tag-and-release:
    name: Tag & Trigger Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Version Files
        run: |
          VERSION="${{ inputs.version }}"
          VERSION=${VERSION#v} # Remove 'v' prefix if present
          echo "Syncing version to $VERSION..."

          # 1. Update package.json
          jq --arg v "$VERSION" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json
          
          # 2. Update Cargo.toml (Workspace)
          # Updates the first occurrence of version = "..." starting at the beginning of a line
          sed -i 's/^version = "[^"]*"/version = "'$VERSION'"/' Cargo.toml
          
          # 3. Update Homebrew Formula
          sed -i 's/version "[^"]*"/version "'$VERSION'"/' Formula/vanity_crypto.rb
          
          # 4. Update Scoop Manifest
          jq --arg v "$VERSION" '.version = $v' scoop/vanity_crypto.json > scoop/vanity_crypto.json.tmp && mv scoop/vanity_crypto.json.tmp scoop/vanity_crypto.json

          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Create Release Branch and PR
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          VERSION="$VERSION"
          BRANCH_NAME="release/v$VERSION"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          echo "Creating branch $BRANCH_NAME..."
          git checkout -b "$BRANCH_NAME"
          
          git add package.json Cargo.toml Formula/vanity_crypto.rb scoop/vanity_crypto.json
          
          if git diff --staged --quiet; then
            echo "No version changes detected."
          else
            echo "Committing version bump..."
            git commit -m "chore: release v$VERSION"
            
            echo "Pushing branch..."
            git push origin "$BRANCH_NAME"
            
            echo "Creating Pull Request..."
            gh pr create \
              --title "chore: release v$VERSION" \
              --body "Automated release preparation for v$VERSION. Merging this PR will trigger the auto-tag workflow and build the release." \
              --base main \
              --head "$BRANCH_NAME"
              
            echo "Release PR created! Merge it to trigger the release."
          fi
