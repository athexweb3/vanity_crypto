name: Manual Release Trigger

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.2.0)'
        required: true
        type: string

permissions:
  contents: write

jobs:
  tag-and-release:
    name: Tag & Trigger Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update Version Files
        run: |
          VERSION="${{ inputs.version }}"
          VERSION=${VERSION#v} # Remove 'v' prefix if present
          echo "Syncing version to $VERSION..."

          # 1. Update package.json
          jq --arg v "$VERSION" '.version = $v' package.json > package.json.tmp && mv package.json.tmp package.json
          
          # 2. Update Cargo.toml (Workspace)
          # Updates the first occurrence of version = "..." starting at the beginning of a line
          sed -i 's/^version = "[^"]*"/version = "'$VERSION'"/' Cargo.toml
          
          # 3. Update Homebrew Formula
          sed -i 's/version "[^"]*"/version "'$VERSION'"/' Formula/vanity_crypto.rb
          
          # 4. Update Scoop Manifest
          jq --arg v "$VERSION" '.version = $v' scoop/vanity_crypto.json > scoop/vanity_crypto.json.tmp && mv scoop/vanity_crypto.json.tmp scoop/vanity_crypto.json

          echo "VERSION=$VERSION" >> $GITHUB_ENV

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add package.json Cargo.toml Formula/vanity_crypto.rb scoop/vanity_crypto.json
          
          if git diff --staged --quiet; then
            echo "No version changes detected."
          else
            echo "Committing version bump..."
            git commit -m "chore: release v$VERSION"
            git push origin HEAD
          fi

      - name: Tag and Push Release
        run: |
          TAG="v$VERSION"
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "Tag $TAG already exists."
          else
            echo "Tagging release $TAG..."
            git tag -a "$TAG" -m "Manual Release $TAG"
            git push origin "$TAG"
          fi
          echo "Release $TAG triggered!"
